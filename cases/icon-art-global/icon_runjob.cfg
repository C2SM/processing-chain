#!/usr/bin/env bash
#SBATCH --job-name="{cfg.CASENAME}_{cfg.inidate_yyyymmddhh}_{cfg.forecasttime}"
#SBATCH --account={cfg.COMPUTE_ACCOUNT}
#SBATCH --time={cfg.ICON_WALLTIME}
#SBATCH --nodes={cfg.ICON_NP_TOT}
#SBATCH --ntasks-per-core=1
#SBATCH --ntasks-per-node={cfg.NTASKS_PER_NODE}
#SBATCH --cpus-per-task=1
#SBATCH --partition={cfg.COMPUTE_QUEUE}
#SBATCH --constraint={cfg.CONSTRAINT}
#SBATCH --hint=nomultithread
#SBATCH --output={logfile}
#SBATCH --open-mode=append
#SBATCH --chdir={cfg.icon_work}

# -- OpenMP environment variables                                                 
export OMP_NUM_THREADS=1                                                       
export ICON_THREADS=1                                                          
export OMP_SCHEDULE=static,12                                                  
export OMP_DYNAMIC="false"                                                     
export OMP_STACKSIZE=200M         


# -- ECCODES path                                               
export ECCODES_DEFINITION_PATH=/store/empa/em05/eccodes_definitions/definitions.edzw-2.12.5-2
export ECCODES_DEFINITION_PATH=$ECCODES_DEFINITION_PATH:/store/empa/em05/easybuild.backup/software/ecCodes/2.12.5-CrayGNU-20.08/share/eccodes/definitions
export ECCODES_DEFINITION_PATH=$ECCODES_DEFINITION_PATH:/project/g110/spack-install/daint/eccodes/2.19.0/pgi/6skdmw5lsn6mjv4esxkyalf6xogllshi/share/eccodes/definitions/

set -x

# ----------------------------------------------------------------------------
# Create ICON master namelist
# ----------------------------------------------------------------------------

cat > icon_master.namelist << EOF
! master_nml: ----------------------------------------------------------------
&master_nml
 lrestart                   =                      {cfg.lrestart}                  ! .TRUE.=current experiment is resumed
/

! master_time_control_nml: ----------------------------------------------------------------
&master_time_control_nml
 restartTimeIntval          =                      "{cfg.restart_time_interval}"     ! Time interval for writing restart files
/

! master_model_nml: repeated for each model ----------------------------------
&master_model_nml
 model_type                  =                          1         ! identifies which component to run (atmosphere,ocean,...)
 model_name                  =                      "ATMO"        ! character string for naming this component.
 model_namelist_filename     =              "NAMELIST_NWP"        ! file name containing the model namelists
 model_min_rank              =                          1         ! start MPI rank for this model
 model_max_rank              =                      65536         ! end MPI rank for this model
 model_inc_rank              =                          1         ! stride of MPI ranks
/

! time_nml: specification of date and time------------------------------------
&time_nml
 ini_datetime_string         =      "{cfg.ini_datetime_string}"        ! initial date and time of the simulation
 end_datetime_string         =      "{cfg.end_datetime_string}"        ! end date and time of the simulation
/
EOF

# ----------------------------------------------------------------------
# Create model namelists
# ----------------------------------------------------------------------

cat > NAMELIST_NWP << EOF
! parallel_nml: MPI parallelization -------------------------------------------
&parallel_nml
 nproma                      =                          8         ! optimal setting 8 for CRAY; use 16 or 24 for IBM
 p_test_run                  =                    .FALSE.         ! .TRUE. means verification run for MPI parallelization
 l_test_openmp               =                    .FALSE.
 l_log_checks                =                    .FALSE. 
 num_io_procs                =                         1          ! up to one PE per output stream is possible
 itype_comm                  =                         1
 iorder_sendrecv             =                         3          ! sequence of MPI send/receive calls
/

! run_nml: general switches ---------------------------------------------------
&run_nml
 num_lev                     =                         50                    ! number of full levels (atm.) for each domain
 lvert_nest                  =                      .FALSE.                  ! vertical nesting
 dtime                       =                        900                    ! timestep in seconds
 ldynamics                   =                      .TRUE.                   ! compute adiabatic dynamic tendencies
 ltransport                  =                      .TRUE.                   ! compute large-scale tracer transport
 iforcing                    =                          3                    ! forcing of dynamics and transport by parameterized processes
 ltestcase                   =                     .FALSE.                   ! real case run
 msg_level                   =                         10                    ! detailed report during integration
 ltimer                      =                      .FALSE.                  ! timer for monitoring the runtime of specific routines
 timers_level                =                          1                    ! performance timer granularity
 output                      =                        "nml"                  ! main switch for enabling/disabling components of the model output
 lart                        =                      .TRUE.                   ! main switch for ART
 restart_filename            =  '{cfg.icon_restart_out}/restart_<rsttime>.nc'    ! restart filename
/

! grid_nml: horizontal grid --------------------------------------------------
&grid_nml
 dynamics_grid_filename      = "{cfg.dynamics_grid_filename_scratch}"    ! array of the grid filenames for the dycore
 dynamics_parent_grid_id     =                          0                ! array of the indexes of the parent grid filenames
 lredgrid_phys               =                      .TRUE.               ! .true.=radiation is calculated on a reduced grid
 lfeedback                   =                      .TRUE.               ! specifies if feedback to parent grid is performed
 ifeedback_type              =                          2                ! feedback type (incremental/relaxation-based)
/

! extpar_nml: external data --------------------------------------------------
&extpar_nml
 itopo                       =                          1         ! topography (0:analytical)
 extpar_filename             = '{cfg.extpar_filename_scratch}'    ! filename of external parameter input file
 n_iter_smooth_topo          =                          1         ! iterations of topography smoother
 itype_vegetation_cycle      =                          1         ! specifics for annual cycle of LAI
 hgtdiff_max_smooth_topo     =                        750.             
/

! initicon_nml: specify read-in of initial state ------------------------------
&initicon_nml
 init_mode                   =                            2            ! 2: start from IFS data
 ifs2icon_filename           = "{cfg.inicond_filename_scratch}"        ! initial data filename
 zpbl1                       =                            500.         
 zpbl2                       =                           1000.         
/ 

! interpol_nml: settings for internal interpolation methods ------------------
&interpol_nml
 nudge_zone_width            =                          8         ! width of lateral boundary nudging zone
 lsq_high_ord                =                          3
 l_intp_c2l                  =                         .TRUE.
 l_mono_c2l                  =                         .TRUE.
/

! io_nml: general switches for model I/O -------------------------------------
&io_nml
 itype_pres_msl              =                          4         ! method for computation of mean sea level pressure
 itype_rh                    =                          1         ! method for computation of relative humidity
/

! nwp_phy_nml: switches for the physics schemes ------------------------------
&nwp_phy_nml
 inwp_gscp                   =                          1         ! cloud microphysics and precipitation
 inwp_convection             =                          1         ! convection
 inwp_radiation              =                          1         ! radiation
 inwp_cldcover               =                          1         ! cloud cover scheme for radiation
 inwp_turb                   =                          1         ! vertical diffusion and transfer
 inwp_satad                  =                          1         ! saturation adjustment
 inwp_sso                    =                          1         ! subgrid scale orographic drag
 inwp_gwd                    =                          1         ! non-orographic gravity wave drag
 inwp_surface                =                          1         ! surface scheme
 icapdcycl                   =                          3         ! apply CAPE modification to improve diurnalcycle over tropical land
 latm_above_top              =                      .FALSE.        ! take into account atmosphere above model top for radiation computation
 efdt_min_raylfric           =                       3600.        ! minimum e-folding time of Rayleigh friction
 itype_z0                    =                          2         ! type of roughness length data
 icpl_aero_conv              =                          1         ! coupling between autoconversion and Tegen aerosol climatology
 icpl_aero_gscp              =                          1         ! coupling between autoconversion and Tegen aerosol climatology
 lrtm_filename               = '{cfg.lrtm_filename_scratch}'      ! longwave absorption coefficients for RRTM_LW
 cldopt_filename             = '{cfg.cldopt_filename_scratch}'   ! RRTM cloud optical properties
 dt_rad                      =                       2160.       ! time step for radiation in s
 dt_conv                     =                        720.       ! time step for convection in s (domain specific)
 dt_sso                      =                       1440.       ! time step for SSO parameterization
 dt_gwd                      =                       1440.       ! time step for gravity wave drag parameterization
 mu_rain                     =                         0.5
 rain_n0_factor              =                         0.1
/

! nwp_tuning_nml: additional tuning parameters ----------------------------------
&nwp_tuning_nml
 tune_zceff_min              =                        0.05        ! ** default value to be used for R3B7; use 0.05 for R2B6 in order to get similar temperature biases in upper troposphere **
 itune_albedo                =                          1         ! reduced albedo (w.r.t. MODIS data) over Sahara
 tune_gkdrag                 =                        0.09
 tune_gkwake                 =                         1.8
 tune_gfrcrit                =                       0.333
 tune_dust_abs               =                          1.
 tune_zvz0i                  =                         1.1
 tune_box_liq_asy            =                         3.0
/

! turbdiff_nml: turbulent diffusion -------------------------------------------
&turbdiff_nml
 pat_len                     =                        750.0       ! effective length scale of thermal surface patterns
 rat_sea                     =                          0.8       ! controls laminar resistance for sea surface : VERY IMPORTANT TO KEEP DEFAULT VALUE --> big temp decline
 frcsmot                     =                          0.2       ! these 2 switches together apply vertical smoothing of the TKE source terms
 imode_frcsmot               =                            2       ! in the tropics (only), which reduces the moist bias in the tropical lower troposphere
 
 itype_sher                  =                            3       ! type of shear forcing used in turbulence
 ltkeshs                     =                        .TRUE.      ! include correction term for coarse grids in hor. shear production term
 a_hshr                      =                          2.0       ! length scale factor for separated horizontal shear mode
 alpha1                      =                          0.5
 icldm_turb                  =                            1       ! mode of cloud water representation in turbulence
/


! radiation_nml: radiation scheme ---------------------------------------------
&radiation_nml
 irad_o3                     =                          7         ! ozone climatology
 irad_aero                   =                          6         ! aerosols
 albedo_type                 =                          2         ! type of surface albedo
 vmr_co2                     =                    407.e-06        ! 2018 values
 vmr_ch4                     =                   1857.e-09
 vmr_n2o                     =                   330.9e-09
 vmr_o2                      =                     0.20946
 vmr_cfc11                   =                    240.e-12
 vmr_cfc12                   =                    532.e-12
/

! nonhydrostatic_nml: nonhydrostatic model -----------------------------------
&nonhydrostatic_nml
 iadv_rhotheta               =                          2         ! advection method for rho and rhotheta
 ivctype                     =                          2         ! type of vertical coordinate
 itime_scheme                =                          4         ! time integration scheme
 exner_expol                 =                          0.333     ! temporal extrapolation of Exner function
 vwind_offctr                =                          0.2       ! off-centering in vertical wind solver
 damp_height                 =                      44000.0       ! height at which Rayleigh damping of vertical wind starts
 rayleigh_coeff              =                          1         ! Rayleigh damping coefficient
 lhdiff_rcf                  =                       .TRUE.
 divdamp_order               =                         24         ! order of divergence damping 
 divdamp_type                =                         32         ! type of divergence damping
 divdamp_fac                 =                          0.004     ! scaling factor for divergence damping
 l_open_ubc                  =                     .FALSE.        ! .TRUE.=use open upper boundary condition
 igradp_method               =                          3         ! discretization of horizontal pressure gradient
 l_zdiffu_t                  =                      .TRUE.        ! specifies computation of Smagorinsky temperature diffusion
 thslp_zdiffu                =                          0.02      ! slope threshold (temperature diffusion)
 thhgtd_zdiffu               =                        125.0       ! threshold of height difference (temperature diffusion)
 htop_moist_proc             =                      22500.0       ! max. height for moist physics
 hbot_qvsubstep              =                      22500.0       ! height above which QV is advected with substepping scheme
/

! sleve_nml: vertical level specification -------------------------------------
&sleve_nml
 min_lay_thckn               =                         20.0       ! minimum layer thickness of lowermost layer
 max_lay_thckn               =                         400.0      ! maximum layer thickness below htop_thcknlimit
 htop_thcknlimit             =                       15000.0     
 top_height                  =                       75000.0      ! height of model top
 stretch_fac                 =                          0.9       ! stretching factor to vary distribution of model levels
 decay_scale_1               =                       4000.0       ! decay scale of large-scale topography component
 decay_scale_2               =                       2500.0       ! decay scale of small-scale topography component
 decay_exp                   =                          1.2       ! exponent of decay function
 flat_height                 =                      16000.0       ! height above which the coordinate surfaces are flat
/

! dynamics_nml: dynamical core -----------------------------------------------
&dynamics_nml
 iequations                  =                          3         ! type of equations and prognostic variables
 idiv_method                 =                          1         ! method for divergence computation
 divavg_cntrwgt              =                          0.50      ! weight of central cell for divergence averaging
 lcoriolis                   =                       .TRUE.       ! Coriolis force
/

! transport_nml: tracer transport ---------------------------------------------
&transport_nml
 ctracer_list                =                                    '12345'                    ! kann vermutlich raus
 ihadv_tracer                =              52,2,2,2,2,22,22,22,22,22,22                     ! tracer specific method to compute horizontal advection
 ivadv_tracer                =                     3,3,3,3,3,3,3,3,3,3,3                     ! tracer specific method to compute vertical advection
 itype_hlimit                =                     3,4,4,4,4,3,3,3,3,3,3                     ! type of limiter for horizontal transport
 iadv_tke                    =                                         0
/

! lnd_nml: land scheme switches -----------------------------------------------
&lnd_nml
 sstice_mode                 =                          2
/

! diffusion_nml: horizontal (numerical) diffusion ----------------------------
&diffusion_nml
 hdiff_order                 =                          5         ! order of nabla operator for diffusion
 itype_vn_diffu              =                          1         ! reconstruction method used for Smagorinsky diffusion
 itype_t_diffu               =                          2         ! discretization of temperature diffusion
 hdiff_efdt_ratio            =                         24.0       ! ratio of e-folding time to time step 
 hdiff_smag_fac              =                          0.025     ! scaling factor for Smagorinsky diffusion
 lhdiff_vn                   =                      .TRUE.        ! diffusion on the horizontal wind field
 lhdiff_temp                 =                      .TRUE.        ! diffusion on the temperature field
 lhdiff_w                    =                      .TRUE.        ! diffusion on the vertical wind field
/

! art_nml: Aerosols and Reactive Trace gases extension-------------------------------------------------
&art_nml
 lart_diag_out              =                        .TRUE.                 ! If this switch is set to .TRUE., diagnostic
                                                                            ! ... output elds are available. Set it to
                                                                            ! ... .FALSE. when facing memory problems.
 lart_pntSrc                =                        .TRUE.                 ! enables point sources
 lart_chem                  =                        .TRUE.                 ! enables chemistry
 lart_chemtracer            =                        .TRUE.                 ! main switch for the treatment of chemical tracer
 lart_aerosol               =                       .FALSE.                 ! main switch for the treatment of atmospheric aerosol

 iart_init_gas              =                            0
 iart_seasalt               =                            0                  ! enable seasalt

 cart_chemtracer_xml        = '{cfg.chemtracer_xml_filename_scratch}'       ! path to xml file for chemical tracers
 cart_pntSrc_xml            = '{cfg.pntSrc_xml_filename_scratch}'           ! path to xml file for point sources
 cart_input_folder          = '{cfg.ART_INPUT_FOLDER}'                      ! absolute Path to ART source code
/

! output_nml: specifies an output stream --------------------------------------
&output_nml
 filetype                    =                          4                                         ! output format: 2=GRIB2, 4=NETCDFv2
 dom                         =                         -1                                         ! write all domains
 output_bounds               =   0.,{cfg.output_writing_max},{cfg.OUTPUT_WRITING_STEP}    ! start, end, increment
 output_time_unit            =                          3                                         ! Unit of bounds is in hours instead of seconds
 steps_per_file              =               {cfg.steps_per_output}                               ! number of steps per file
 steps_per_file_inclfirst    =                        .FALSE.                                     ! First step is not accounted for in steps_per_file
 include_last                =                        .FALSE.
 mode                        =                          1                                         ! 1: forecast mode (relative t-axis), 2: climate mode (absolute t-axis)
 output_filename             =                    'ICON-ART'
 filename_format             =   '{cfg.icon_output}/<output_filename>_latlon_<datetime2>'                ! file name base
 remap                       =                          1                                         ! 1: remap to lat-lon grid
 reg_lon_def                 =              -180.,2,178                                      
 reg_lat_def                 =               90.,-1,-90.                
 ml_varlist                  =  'z_ifc','z_mc','pres','pres_sfc','qv','rh','rho','temp','u','v','w','t_2m','t_so','group:ART_CHEMISTRY',
/

! output_nml: specifies an output stream --------------------------------------
&output_nml
 filetype                    =                          4                                         ! output format: 2=GRIB2, 4=NETCDFv2
 dom                         =                         -1                                         ! write all domains
 output_bounds               =   0.,{cfg.output_writing_max},{cfg.OUTPUT_WRITING_STEP}    ! start, end, increment
 output_time_unit            =                          3                                         ! Unit of bounds is in hours instead of seconds
 steps_per_file              =               {cfg.steps_per_output}                               ! number of steps per file
 steps_per_file_inclfirst    =                        .FALSE.                                     ! First step is not accounted for in steps_per_file
 include_last                =                        .FALSE.
 mode                        =                          1                                         ! 1: forecast mode (mrelative t-axis), 2: climate mode (absolute t-axis)
 output_filename             =                    'ICON-ART'
 filename_format             =   '{cfg.icon_output}/<output_filename>_unstr_<datetime2>'                ! file name base
 remap                       =                          0                                         ! 1: remap to lat-lon grid
 ml_varlist                  =  'z_ifc','z_mc','pres','pres_sfc','qv','rh','rho','temp','u','v','w','t_2m','t_so','t_sk','t_s','lhfl_s','shfl_s','swflx_dn','swflx_up','lwflx_dn','lwflx_up','lw_emiss','albdif','t_seasfc','group:ART_CHEMISTRY',
/



EOF

# ----------------------------------------------------------------------
# run the model!
# ----------------------------------------------------------------------
 srun ./icon.exe



#  ! output_nml: specifies an output stream --------------------------------------
# &output_nml
#  filetype                    =                          4                                        ! output format: 2=GRIB2, 4=NETCDFv2
#  dom                         =                         -1                                        ! write all domains
#  output_bounds               =        0., 2678400., 3600.                                        ! start, end, increment
#  steps_per_file              =                          1                                        ! number of steps per file
#  mode                        =                          1                                        ! 1: forecast mode (relative t-axis), 2: climate mode (absolute t-axis)
#  include_last                =                      .TRUE.
#  output_filename             =                    'ICON-ART'
#  filename_format             =   '{cfg.icon_output}/<output_filename>_latlon_<datetime2>'         ! file name base
#  remap                       =                          1                                         ! 1: remap to lat-lon grid
#  reg_lon_def                 =              -180.,2,178                                      
#  reg_lat_def                 =               90.,-1,-90.                               
#  ml_varlist                  =  'z_ifc','z_mc','pres','pres_sfc','qc','rh','rho','temp','u','v','w','group:ART_CHEMISTRY',
# /