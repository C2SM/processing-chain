<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>run_chain &mdash; Processing Chain v3.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/processing-chain-favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=de725823"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=a5fa425f"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #5d6d7e" >

          
          
          <a href="../index.html">
            
              <img src="../_static/processing-chain-logo-small.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environment.html">Conda Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../environment.html#install-miniconda">1. Install Miniconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment.html#create-the-conda-environment">2. Create the Conda Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../environment.html#store-user-specific-data">3. Store user-specific data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../howtorun.html">How to Run</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../howtorun.html#starting-the-chain">Starting the Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howtorun.html#what-it-does">What it Does</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howtorun.html#test-cases">Test Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howtorun.html#directory-structure">Directory Structure</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code-structure.html">Code Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration File</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../config.html#general-variables-in-run-chain-py">General Variables in <code class="docutils literal notranslate"><span class="pre">run_chain.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../config.html#variables-to-set-in-config-yaml">Variables to Set in <code class="docutils literal notranslate"><span class="pre">config.yaml</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../namelists.html">Namelist and Runscript Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../namelists.html#jobs.tools.write_int2lm_input_art.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.write_int2lm_input_art.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../namelists.html#jobs.tools.write_cosmo_input_ghg.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.write_cosmo_input_ghg.main()</span></code></a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jobs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../jobs.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs.html#adding-new-jobs">Adding New Jobs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Function Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">Jobs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.biofluxes.main"><code class="docutils literal notranslate"><span class="pre">jobs.biofluxes.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.check_output.main"><code class="docutils literal notranslate"><span class="pre">jobs.check_output.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.cosmo.main"><code class="docutils literal notranslate"><span class="pre">jobs.cosmo.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.emissions.main"><code class="docutils literal notranslate"><span class="pre">jobs.emissions.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.icon.main"><code class="docutils literal notranslate"><span class="pre">jobs.icon.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.int2lm.main"><code class="docutils literal notranslate"><span class="pre">jobs.int2lm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.obs_nudging.main"><code class="docutils literal notranslate"><span class="pre">jobs.obs_nudging.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.octe.main"><code class="docutils literal notranslate"><span class="pre">jobs.octe.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.oem.main"><code class="docutils literal notranslate"><span class="pre">jobs.oem.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.online_vprm.main"><code class="docutils literal notranslate"><span class="pre">jobs.online_vprm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.photo_rate.main"><code class="docutils literal notranslate"><span class="pre">jobs.photo_rate.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.post_cosmo.main"><code class="docutils literal notranslate"><span class="pre">jobs.post_cosmo.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.post_int2lm.main"><code class="docutils literal notranslate"><span class="pre">jobs.post_int2lm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.prepare_data.main"><code class="docutils literal notranslate"><span class="pre">jobs.prepare_data.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.reduce_output.main"><code class="docutils literal notranslate"><span class="pre">jobs.reduce_output.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.verify_chain.main"><code class="docutils literal notranslate"><span class="pre">jobs.verify_chain.main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html#tools">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.cams4int2cosmo.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.cams4int2cosmo.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.check_model.check_model"><code class="docutils literal notranslate"><span class="pre">jobs.tools.check_model.check_model()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.comp_nc.datasets_equal"><code class="docutils literal notranslate"><span class="pre">jobs.tools.comp_nc.datasets_equal()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.ctnoaa4int2cosmo.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.ctnoaa4int2cosmo.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.mozart2int2lm.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.mozart2int2lm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.reduce_output_start_end.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.reduce_output_start_end.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.string2char.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.string2char.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.vprmsplit.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.vprmsplit.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.write_cosmo_input_ghg.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.write_cosmo_input_ghg.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../functions.html#jobs.tools.write_int2lm_input_art.main"><code class="docutils literal notranslate"><span class="pre">jobs.tools.write_int2lm_input_art.main()</span></code></a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #5d6d7e" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Processing Chain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">run_chain</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for run_chain</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">jobs</span>
<span class="kn">from</span> <span class="nn">jobs</span> <span class="kn">import</span> <span class="n">tools</span>


<span class="k">def</span> <span class="nf">parse_arguments</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse command line arguments for the processing chain script.</span>

<span class="sd">    Parses and retrieves command line arguments, allowing users to specify</span>
<span class="sd">    run identifiers, jobs to execute, and various options to control the</span>
<span class="sd">    execution of the processing chain.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    argparse.Namespace</span>
<span class="sd">        A namespace object containing parsed command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run the processing chain.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;casenames&quot;</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of identifiers for the runs. &quot;</span>
                        <span class="s2">&quot;The config-files for each run is assumed &quot;</span>
                        <span class="s2">&quot;to be in cases/&lt;casename&gt;/. The runs are executed &quot;</span>
                        <span class="s2">&quot;sequentially in the order they&#39;re given here.&quot;</span><span class="p">)</span>

    <span class="n">jobs_help</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;List of job-names to be executed. A job is a .py-&quot;</span>
                 <span class="s2">&quot;file in jobs/ with a main()-function which &quot;</span>
                 <span class="s2">&quot;handles one aspect of the processing chain, for &quot;</span>
                 <span class="s2">&quot;example copying meteo-input data or launching a &quot;</span>
                 <span class="s2">&quot;job for int2lm. &quot;</span>
                 <span class="s2">&quot;Jobs are executed in the order in which they are &quot;</span>
                 <span class="s2">&quot;given here. &quot;</span>
                 <span class="s2">&quot;If no jobs are given, default jobs will be executed&quot;</span>
                 <span class="s2">&quot;as defined in config/models.yaml.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-j&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;--jobs&quot;</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;job_list&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">jobs_help</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">force_help</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Force the processing chain to redo all specified jobs,&quot;</span>
                  <span class="s2">&quot; even if they have been started already or were finished&quot;</span>
                  <span class="s2">&quot; previously. WARNING: Only logfiles get deleted,&quot;</span>
                  <span class="s2">&quot; other effects of a given job (copied files etc.)&quot;</span>
                  <span class="s2">&quot; are simply overwritten. This may cause errors.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--force&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">force_help</span><span class="p">)</span>

    <span class="n">tries_help</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Amount of time the cosmo job is re-tried before crashing.&quot;</span>
                  <span class="s2">&quot; Default is 1.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;--try&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">tries_help</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ntry&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">resume_help</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Resume the processing chain by restarting the last unfinished job.&quot;</span>
        <span class="s2">&quot; WARNING: Only the logfile gets deleted,&quot;</span>
        <span class="s2">&quot; other effects of a given job (copied files etc.)&quot;</span>
        <span class="s2">&quot; are simply overwritten. This may cause errors.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;--resume&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">resume_help</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;resume&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">casename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an instance of the Config class.</span>

<span class="sd">        Initializes an instance of the Config class with user-specific</span>
<span class="sd">        and default attributes. The class represents a processing chain for a</span>
<span class="sd">        particular case, and its attributes are populated based on the provided</span>
<span class="sd">        `casename`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        casename : str</span>
<span class="sd">            The identifier for the case, typically specifying the configuration</span>
<span class="sd">            and settings to be used in the processing chain.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        user_name : str</span>
<span class="sd">            The username of the current user, obtained from the &#39;USER&#39; environment variable.</span>
<span class="sd">        email : str</span>
<span class="sd">            The user&#39;s email address, initially set to None and updated using the `set_email` method.</span>
<span class="sd">        casename : str</span>
<span class="sd">            The specified case name for the processing chain.</span>
<span class="sd">        chain_src_dir : str</span>
<span class="sd">            The source directory for the processing chain, typically the current working directory.</span>
<span class="sd">        case_path : str</span>
<span class="sd">            The path to the case directory under &#39;cases/&#39; for the specified `casename`.</span>
<span class="sd">        work_root : str</span>
<span class="sd">            The root directory for processing chain execution, typically located under the source directory.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The method also loads user-defined attributes from the configuration file,</span>
<span class="sd">        sets specific settings based on the node type (&#39;gpu&#39; or &#39;mc&#39;), and initializes</span>
<span class="sd">        other instance-specific attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Global attributes (initialized with default values)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USER&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_email</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">casename</span> <span class="o">=</span> <span class="n">casename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_account</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chain_src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_src_dir</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">casename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_src_dir</span><span class="p">,</span> <span class="s1">&#39;work&#39;</span><span class="p">)</span>

        <span class="c1"># User-defined attributes from config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config_file</span><span class="p">(</span><span class="n">casename</span><span class="p">)</span>

        <span class="c1"># Specific settings based on the node type (&#39;gpu&#39; or &#39;mc&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_node_info</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">casename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load configuration settings from a YAML file and set them as attributes.</span>

<span class="sd">        This method reads the configuration settings from a YAML file located in</span>
<span class="sd">        the &#39;cases/casename&#39; directory and sets them as attributes of the instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        casename : str</span>
<span class="sd">            Name of the folder in &#39;cases/&#39; where the configuration files are stored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with configuration settings as attributes.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            If the specified configuration file or case directory is not found.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the configuration file does not exist, the method will attempt to suggest</span>
<span class="sd">        a similar case directory based on a Levenshtein distance comparison with</span>
<span class="sd">        existing case directories. The method directly assigns values from the</span>
<span class="sd">        configuration file to instance attributes for easy access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="n">casename</span><span class="p">,</span> <span class="s1">&#39;config.yaml&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">):</span>
            <span class="n">all_cases</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">path</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="s1">&#39;cases&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="n">closest_name</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([(</span><span class="n">tools</span><span class="o">.</span><span class="n">levenshtein</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_cases</span><span class="p">],</span>
                               <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Case-directory &#39;</span><span class="si">{</span><span class="n">casename</span><span class="si">}</span><span class="s2">&#39; not found, did you mean &#39;</span><span class="si">{</span><span class="n">closest_name</span><span class="si">}</span><span class="s2">&#39;?&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yaml_file</span><span class="p">:</span>
                <span class="n">cfg_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No file &#39;config.yaml&#39; in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Directly assign values to instance attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cfg_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the compute account based on user information.</span>

<span class="sd">        This method determines the compute account to be used based on the user&#39;s</span>
<span class="sd">        name and system configuration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with the `compute_account` attribute set.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If the user name is &#39;jenkins&#39;, the compute account is set to &#39;g110&#39; for</span>
<span class="sd">        Jenkins testing.</span>
<span class="sd">        - If an account is specified in the user&#39;s &#39;~/.acct&#39; file, it will be used</span>
<span class="sd">        as the compute account.</span>
<span class="sd">        - If neither of the above conditions is met, the standard account is</span>
<span class="sd">        determined using the &#39;id -gn&#39; command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">==</span> <span class="s1">&#39;jenkins&#39;</span><span class="p">:</span>
            <span class="c1"># g110 account for Jenkins testing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_account</span> <span class="o">=</span> <span class="s1">&#39;g110&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.acct&#39;</span><span class="p">):</span>
            <span class="c1"># Use account specified in ~/.acct file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.acct&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_account</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use standard account</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_account</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;id -gn&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_node_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set node-specific information based on configuration settings.</span>

<span class="sd">        This method configures node-specific settings, such as the number of tasks</span>
<span class="sd">        per node and CUDA-related environment variables, based on the provided</span>
<span class="sd">        configuration settings in the instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with updated node-specific attributes.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the &#39;constraint&#39; or &#39;run_on&#39; configuration values are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_on</span> <span class="o">==</span> <span class="s1">&#39;gpu&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntasks_per_node</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_on</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ntasks_per_node</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid value for &#39;run_on&#39; in the configuration.&quot;</span>
                        <span class="s2">&quot;It should be either &#39;gpu&#39; or &#39;cpu&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ntasks_per_node</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mpich_cuda</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;export MPICH_RDMA_ENABLED_CUDA=1</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;export MPICH_G2G_PIPELINE=256</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;export CRAY_CUDA_MPS=1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">==</span> <span class="s1">&#39;mc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntasks_per_node</span> <span class="o">=</span> <span class="mi">36</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpich_cuda</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid value for &#39;constraint&#39; in the configuration.&quot;</span>
                <span class="s2">&quot;It should be either &#39;gpu&#39; or &#39;mc&#39;.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_restart_step_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the restart step in hours.</span>

<span class="sd">        Converts the &#39;restart_step&#39; attribute, which is in ISO8601 duration format,</span>
<span class="sd">        to hours and stores the result in the &#39;restart_step_hours&#39; attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with the &#39;restart_step_hours&#39; attribute set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_step_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">tools</span><span class="o">.</span><span class="n">iso8601_duration_to_hours</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_step</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the user&#39;s email address based on system configuration.</span>

<span class="sd">        This method determines the user&#39;s email address based on the user&#39;s name</span>
<span class="sd">        and system configuration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with the `user_mail` attribute set.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If the user name is &#39;jenkins&#39;, the user&#39;s email address is set to None.</span>
<span class="sd">        - If an email address is specified in the user&#39;s &#39;~/.forward&#39; file, it will</span>
<span class="sd">        be used as the user&#39;s email address.</span>
<span class="sd">        - If neither of the above conditions is met, the user&#39;s email address is set</span>
<span class="sd">        to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">==</span> <span class="s1">&#39;jenkins&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_mail</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.forward&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.forward&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_mail</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_mail</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the configuration attributes and their values.</span>

<span class="sd">        This method displays the configuration attributes and their corresponding</span>
<span class="sd">        values in a formatted manner. Lists and dictionaries within the configuration</span>
<span class="sd">        are also displayed with appropriate indentation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The maximum column width for the attribute names is automatically determined.</span>
<span class="sd">        - The method prints the attribute name, its type, and its value.</span>
<span class="sd">        - If an attribute is a list, it is displayed with each item indented.</span>
<span class="sd">        - If an attribute is a dictionary, it is also displayed with each key-value</span>
<span class="sd">        pair indented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># max_col_width = max(len(key) for key in vars(self)) + 1</span>
        <span class="n">max_col_width</span> <span class="o">=</span> <span class="mi">27</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuration:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Attribute&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="si">}}</span><span class="s2"> Type Value&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># If the value is a list, format it with indentation</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="si">}}</span><span class="s2"> list&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">item_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">item</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="o">-</span><span class="mi">4</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="n">item_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># If the value is a dictionary, format it as before</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="si">}}</span><span class="s2"> dict&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">sub_value_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">sub_key</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="o">-</span><span class="mi">4</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="n">sub_value_type</span><span class="si">:</span><span class="s2">&lt;4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sub_value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Standard output</span>
                <span class="n">key_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">max_col_width</span><span class="si">}}</span><span class="s2"> </span><span class="si">{</span><span class="n">key_type</span><span class="si">:</span><span class="s2">&lt;4</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_paths_to_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert relative file paths to absolute paths in the configuration.</span>

<span class="sd">        This method iterates through all variables and their dictionary entries in</span>
<span class="sd">        the configuration and checks for string values that represent file paths.</span>
<span class="sd">        If a file path is relative (starts with &#39;./&#39;), it is converted to an</span>
<span class="sd">        absolute path using `os.path.abspath`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with relative file paths converted to absolute paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Loop through all variables and their dictionary entries</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">attr_value</span><span class="p">):</span>
                    <span class="c1"># If the value is already an absolute path, continue to the next iteration</span>
                    <span class="k">continue</span>
                <span class="c1"># Convert relative paths to absolute paths</span>
                <span class="k">if</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># If the attribute is a dictionary, loop through its entries</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                            <span class="c1"># If the value is already an absolute path, continue to the next iteration</span>
                            <span class="k">continue</span>
                        <span class="c1"># Convert relative paths to absolute paths</span>
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                                <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">create_vars_from_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create instance attributes from dictionary entries in the configuration.</span>

<span class="sd">        This method iterates through the instance&#39;s attribute dictionary and checks</span>
<span class="sd">        for dictionary values. For each dictionary encountered, it creates new</span>
<span class="sd">        instance attributes by concatenating the original attribute name and the</span>
<span class="sd">        dictionary key, and assigns the corresponding values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Config</span>
<span class="sd">            The same `Config` instance with new attributes created from dictionary entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a copy of the object&#39;s __dict__ to avoid modifying it during iteration</span>
        <span class="n">object_dict</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">object_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="run_chain"><a class="viewcode-back" href="../howtorun.html#run_chain.run_chain">[docs]</a><span class="k">def</span> <span class="nf">run_chain</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">startdate_sim</span><span class="p">,</span> <span class="n">enddate_sim</span><span class="p">,</span> <span class="n">job_names</span><span class="p">,</span>
              <span class="n">force</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the processing chain, managing job execution and logging.</span>

<span class="sd">    This function sets up and manages the execution of a processing chain, handling</span>
<span class="sd">    job execution, logging, and various configuration settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    work_root : str</span>
<span class="sd">        The path to the directory where the processing chain writes files during execution.</span>
<span class="sd">    model_cfg : dict</span>
<span class="sd">        Configuration settings for the modeling framework.</span>
<span class="sd">    cfg : Config</span>
<span class="sd">        Object holding user-defined configuration parameters as attributes.</span>
<span class="sd">    startdate_sim : datetime-object</span>
<span class="sd">        The start date of the simulation.</span>
<span class="sd">    enddate_sim : datetime-object</span>
<span class="sd">        The end date of the simulation.</span>
<span class="sd">    job_names : list of str</span>
<span class="sd">        List of names of jobs to execute on every timeslice.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If True, it will force the execution of jobs regardless of their completion status.</span>
<span class="sd">    resume : bool</span>
<span class="sd">        If True, it will resume the last unfinished job.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If an error or timeout occurs during job execution.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This function sets various configuration values based on the provided parameters.</span>
<span class="sd">    - It checks for job completion status and resumes or forces execution accordingly.</span>
<span class="sd">    - Job log files are managed, and errors or timeouts are handled with notifications.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Write current start and end dates to config variables</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim</span> <span class="o">=</span> <span class="n">startdate_sim</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">=</span> <span class="n">enddate_sim</span>

    <span class="c1"># Set forecast time</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">forecasttime</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">-</span>
                        <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="c1"># String variables for startdate_sim</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_yyyymmddhh</span> <span class="o">=</span> <span class="n">startdate_sim</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_yyyymmddhh</span> <span class="o">=</span> <span class="n">enddate_sim</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

    <span class="c1"># Folder naming and structure</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_yyyymmddhh</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_yyyymmddhh</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># Config variables for spinup runs (datetimes, job-id, etc.)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;spinup&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">first_one</span><span class="p">:</span>  <span class="c1"># first run in spinup</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">chain_root_prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># consecutive runs in spinup</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_yyyymmddhh</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>
            <span class="n">enddate_sim_yyyymmddhh_prev</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">-</span>
                <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">second_one</span><span class="p">:</span>
                <span class="n">startdate_sim_yyyymmddhh_prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span>
                    <span class="n">hours</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all other runs (i.e., get job_id from previous run)</span>
                <span class="n">startdate_sim_yyyymmddhh_prev</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">-</span>
                    <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span> <span class="o">+</span>
                              <span class="n">cfg</span><span class="o">.</span><span class="n">spinup</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

            <span class="n">cfg</span><span class="o">.</span><span class="n">job_id_prev</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">startdate_sim_yyyymmddhh_prev</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">enddate_sim_yyyymmddhh_prev</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">chain_root_prev</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">,</span>
                                               <span class="n">cfg</span><span class="o">.</span><span class="n">job_id_prev</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">last_cosmo_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root_prev</span><span class="p">,</span> <span class="s1">&#39;cosmo&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;output&#39;</span><span class="p">)</span>

        <span class="c1"># No restart for spinup simulations (= default values for no restart)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_restart_out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_restart_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;restart&#39;</span> <span class="ow">in</span> <span class="n">model_cfg</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_prev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span>
            <span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_prev</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span>
            <span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_prev_yyyymmddhh</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_prev</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_prev_yyyymmddhh</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_prev</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

        <span class="n">cfg</span><span class="o">.</span><span class="n">job_id_prev</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">startdate_sim_prev_yyyymmddhh</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">enddate_sim_prev_yyyymmddhh</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">chain_root_prev</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">,</span>
                                           <span class="n">cfg</span><span class="o">.</span><span class="n">job_id_prev</span><span class="p">)</span>

        <span class="c1"># Set restart directories</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_restart_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;cosmo&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;restart&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_restart_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root_prev</span><span class="p">,</span> <span class="s1">&#39;cosmo&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;restart&#39;</span><span class="p">)</span>

    <span class="c1"># Check constraint</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">cfg</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;mc&#39;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;Unknown constraint, use&quot;</span>
                                                 <span class="s2">&quot;gpu or mc&quot;</span><span class="p">)</span>

    <span class="c1"># If nested run: use output of mother-simulation</span>
    <span class="k">if</span> <span class="s1">&#39;nesting&#39;</span> <span class="ow">in</span> <span class="n">model_cfg</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">dir</span><span class="p">):</span>
        <span class="c1"># if ifs_hres_dir doesn&#39;t point to a directory,</span>
        <span class="c1"># it is the name of the mother run</span>
        <span class="n">mother_name</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">mother_name</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                                     <span class="s1">&#39;cosmo&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">inc</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">meteo</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;lffd&#39;</span>

    <span class="c1"># Logging</span>
    <span class="n">log_working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">,</span> <span class="s1">&#39;working&#39;</span><span class="p">)</span>
    <span class="n">log_finished_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;log_working_dir&#39;</span><span class="p">,</span> <span class="n">log_working_dir</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;log_finished_dir&#39;</span><span class="p">,</span> <span class="n">log_finished_dir</span><span class="p">)</span>

    <span class="c1"># Create working directories</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s2">&quot;chain_root&quot;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="s2">&quot;log_working&quot;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="s2">&quot;log_finished&quot;</span><span class="p">)</span>

    <span class="c1"># Number of levels and switch for unit conversion for &#39;reduce_output&#39; job</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;output_levels&#39;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;output_levels&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;convert_gas&#39;</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;convert_gas&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># run jobs (if required)</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if exists job is currently worked on or has been finished</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skip &quot;</span><span class="si">%s</span><span class="s1">&quot; for chain &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                        <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">resume</span><span class="p">:</span>
                        <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Wait for &quot;</span><span class="si">%s</span><span class="s1">&quot; of chain &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3000</span><span class="p">):</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Process &quot;</span><span class="si">%s</span><span class="s1">&quot; for chain &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">try_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ntry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">job</span> <span class="o">==</span> <span class="s1">&#39;cosmo&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">try_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">try_count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Change the log file</span>
                    <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                    <span class="n">logfile_finish</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                    <span class="n">tools</span><span class="o">.</span><span class="n">change_logfile</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>

                    <span class="c1"># Launch the job</span>
                    <span class="n">to_call</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                    <span class="n">to_call</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">)</span>

                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">logfile_finish</span><span class="p">)</span>

                    <span class="n">exitcode</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;ERROR or TIMEOUT in job &#39;</span><span class="si">%s</span><span class="s2">&#39; for chain &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">job</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">prepare_message</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">))</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sending log file to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">)</span>
                        <span class="n">tools</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">try_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">)):</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;ERROR or TIMEOUT in job &#39;</span><span class="si">%s</span><span class="s2">&#39; for chain &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">job</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">prepare_message</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sending log file to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">)</span>
                    <span class="n">tools</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">user_mail</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span></div>


<div class="viewcode-block" id="restart_runs"><a class="viewcode-back" href="../howtorun.html#run_chain.restart_runs">[docs]</a><span class="k">def</span> <span class="nf">restart_runs</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">job_names</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start subchains in specified intervals and manage restarts.</span>

<span class="sd">    This function slices the total runtime of the processing chain according to the</span>
<span class="sd">    `cfg.restart_step_hours` configuration. It calls `run_chain()` for each</span>
<span class="sd">    specified interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    work_root : str</span>
<span class="sd">        The path to the directory in which the chain writes files during execution.</span>
<span class="sd">    model_cfg : dict</span>
<span class="sd">        Configuration settings for the modeling framework.</span>
<span class="sd">    cfg : Config</span>
<span class="sd">        Object holding all user-configuration parameters as attributes.</span>
<span class="sd">    job_names : list of str</span>
<span class="sd">        List of names of jobs to execute on every timeslice.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If True, it will force the execution of jobs regardless of their completion status.</span>
<span class="sd">    resume : bool</span>
<span class="sd">        If True, it will resume the last unfinished job.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function iterates over specified intervals, calling `run_chain()` for each.</span>
<span class="sd">    - It manages restart settings and logging for each subchain.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># run restarts</span>
    <span class="k">for</span> <span class="n">startdate_sim</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">iter_hours</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span>
                                          <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">):</span>
        <span class="n">enddate_sim</span> <span class="o">=</span> <span class="n">startdate_sim</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enddate_sim</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Set restart variable (only takes effect for ICON)</span>
        <span class="k">if</span> <span class="n">startdate_sim</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;lrestart&quot;</span><span class="p">,</span> <span class="s1">&#39;.FALSE.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;lrestart&quot;</span><span class="p">,</span> <span class="s1">&#39;.TRUE.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting run with startdate </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startdate_sim</span><span class="p">))</span>

        <span class="n">run_chain</span><span class="p">(</span><span class="n">work_root</span><span class="o">=</span><span class="n">work_root</span><span class="p">,</span>
                  <span class="n">model_cfg</span><span class="o">=</span><span class="n">model_cfg</span><span class="p">,</span>
                  <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                  <span class="n">startdate_sim</span><span class="o">=</span><span class="n">startdate_sim</span><span class="p">,</span>
                  <span class="n">enddate_sim</span><span class="o">=</span><span class="n">enddate_sim</span><span class="p">,</span>
                  <span class="n">job_names</span><span class="o">=</span><span class="n">job_names</span><span class="p">,</span>
                  <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
                  <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">restart_runs_spinup</span><span class="p">(</span><span class="n">work_root</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">job_names</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start subchains in specified intervals and manage restarts with spin-up.</span>

<span class="sd">    This function slices the total runtime of the processing chain according to the</span>
<span class="sd">    `cfg.restart_step_hours` configuration. It calls `run_chain()` for each specified</span>
<span class="sd">    interval, managing restarts with spin-up.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    work_root : str</span>
<span class="sd">        The path to the directory in which the chain writes files during execution.</span>
<span class="sd">    model_cfg : dict</span>
<span class="sd">        Configuration settings for the modeling framework.</span>
<span class="sd">    cfg : Config</span>
<span class="sd">        Object holding all user-configuration parameters as attributes.</span>
<span class="sd">    job_names : list of str</span>
<span class="sd">        List of names of jobs to execute on every timeslice.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If True, it will force the execution of jobs regardless of their completion status.</span>
<span class="sd">    resume : bool</span>
<span class="sd">        If True, it will resume the last unfinished job.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The function iterates over specified intervals, calling `run_chain()` for each.</span>
<span class="sd">    - It manages restart settings and logging for each subchain, including spin-up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">startdate_sim</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">iter_hours</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span>
                                          <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">startdate_sim</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;first_one&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;second_one&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;lrestart&quot;</span><span class="p">,</span> <span class="s1">&#39;.FALSE.&#39;</span><span class="p">)</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span>
            <span class="n">startdate_sim_spinup</span> <span class="o">=</span> <span class="n">startdate_sim</span>
        <span class="k">elif</span> <span class="n">startdate_sim</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;first_one&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;second_one&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;lrestart&quot;</span><span class="p">,</span> <span class="s1">&#39;.TRUE.&#39;</span><span class="p">)</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">spinup</span>
            <span class="n">startdate_sim_spinup</span> <span class="o">=</span> <span class="n">startdate_sim</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">spinup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;first_one&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;second_one&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;lrestart&quot;</span><span class="p">,</span> <span class="s1">&#39;.TRUE.&#39;</span><span class="p">)</span>
            <span class="n">run_time</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">spinup</span>
            <span class="n">startdate_sim_spinup</span> <span class="o">=</span> <span class="n">startdate_sim</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">spinup</span><span class="p">)</span>

        <span class="c1"># If current enddate is later than global enddate, skip</span>
        <span class="n">enddate_sim</span> <span class="o">=</span> <span class="n">startdate_sim</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">restart_step_hours</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enddate_sim</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">enddate</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime of sub-simulation: </span><span class="si">{</span><span class="n">run_time</span><span class="si">}</span><span class="s1"> h&#39;</span><span class="p">)</span>

        <span class="n">run_chain</span><span class="p">(</span><span class="n">work_root</span><span class="o">=</span><span class="n">work_root</span><span class="p">,</span>
                  <span class="n">model_cfg</span><span class="o">=</span><span class="n">model_cfg</span><span class="p">,</span>
                  <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                  <span class="n">startdate_sim</span><span class="o">=</span><span class="n">startdate_sim_spinup</span><span class="p">,</span>
                  <span class="n">enddate_sim</span><span class="o">=</span><span class="n">enddate_sim</span><span class="p">,</span>
                  <span class="n">job_names</span><span class="o">=</span><span class="n">job_names</span><span class="p">,</span>
                  <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
                  <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_model_config_yaml</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load model configuration from a YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    yamlfile : str</span>
<span class="sd">        The path to the YAML file containing the model configuration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary representing the model configuration loaded from the YAML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yamlfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_cfg</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main script for running a processing chain.</span>

<span class="sd">    This script handles the execution of a processing chain for one or more specified cases. It loads model configurations, prepares the environment, and starts the chain based on the provided settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None (Command-line arguments are parsed internally)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - This script uses command-line arguments to specify cases and job lists.</span>
<span class="sd">    - It loads model configurations, converts paths to absolute, sets restart settings, and starts the chain.</span>
<span class="sd">    - Depending on the model&#39;s features, it may run with or without restarts or utilize spin-up restarts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_arguments</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">casename</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">casenames</span><span class="p">:</span>
        <span class="c1"># Load configs</span>
        <span class="n">model_cfg</span> <span class="o">=</span> <span class="n">load_model_config_yaml</span><span class="p">(</span><span class="s1">&#39;config/models.yaml&#39;</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">casename</span><span class="p">)</span>

        <span class="c1"># Convert relative to absolute paths</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">convert_paths_to_absolute</span><span class="p">()</span>

        <span class="c1"># Set restart step in hours</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">set_restart_step_hours</span><span class="p">()</span>

        <span class="c1"># Print config before duplication of dict variables</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">print_config</span><span class="p">()</span>

        <span class="c1"># Duplicate variables in the form of &lt;dict&gt;_&lt;value&gt; for better</span>
        <span class="c1"># access within namelist template.</span>
        <span class="c1"># E.g.: cfg.meteo[&#39;dir&#39;] -&gt; cfg.meteo_dir</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">create_vars_from_dicts</span><span class="p">()</span>

        <span class="c1"># Check if jobs are set or if default ones are used</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">job_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">job_list</span> <span class="o">=</span> <span class="n">model_cfg</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting chain for case </span><span class="si">{</span><span class="n">casename</span><span class="si">}</span><span class="s2"> and model </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for restart compatibility and spinup</span>
        <span class="k">if</span> <span class="s1">&#39;restart&#39;</span> <span class="ow">in</span> <span class="n">model_cfg</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;spinup&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using spin-up restarts.&quot;</span><span class="p">)</span>
                <span class="n">restart_runs_spinup</span><span class="p">(</span><span class="n">work_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_root</span><span class="p">,</span>
                                    <span class="n">model_cfg</span><span class="o">=</span><span class="n">model_cfg</span><span class="p">,</span>
                                    <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                    <span class="n">job_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_list</span><span class="p">,</span>
                                    <span class="n">force</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                                    <span class="n">resume</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using built-in model restarts.&quot;</span><span class="p">)</span>
                <span class="n">restart_runs</span><span class="p">(</span><span class="n">work_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_root</span><span class="p">,</span>
                             <span class="n">model_cfg</span><span class="o">=</span><span class="n">model_cfg</span><span class="p">,</span>
                             <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                             <span class="n">job_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_list</span><span class="p">,</span>
                             <span class="n">force</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                             <span class="n">resume</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No restarts are used.&quot;</span><span class="p">)</span>
            <span class="n">run_chain</span><span class="p">(</span><span class="n">work_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_root</span><span class="p">,</span>
                      <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                      <span class="n">startdate_sim</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">startdate</span><span class="p">,</span>
                      <span class="n">enddate_sim</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">enddate</span><span class="p">,</span>
                      <span class="n">job_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">job_list</span><span class="p">,</span>
                      <span class="n">force</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                      <span class="n">resume</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Finished the processing chain successfully &lt;&lt;&lt;&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, C2SM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>