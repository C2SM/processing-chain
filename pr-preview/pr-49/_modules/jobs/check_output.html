<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jobs.check_output &mdash; Processing Chain v3.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/processing-chain-favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=de725823"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=a5fa425f"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #5d6d7e" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/processing-chain-logo-small.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">Feature Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../environment.html">Conda Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../environment.html#install-miniconda">1. Install Miniconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../environment.html#create-the-conda-environment">2. Create the Conda Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../environment.html#store-user-specific-data">3. Store user-specific data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../howtorun.html">How to Run</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../howtorun.html#starting-the-chain">Starting the Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../howtorun.html#what-it-does">What it Does</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../howtorun.html#test-cases">Test Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../howtorun.html#directory-structure">Directory Structure</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../file-structure.html">File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration File</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#general-variables-in-config-py">General Variables in <code class="docutils literal notranslate"><span class="pre">config.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-biofluxes-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.biofluxes.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-cosmo-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.cosmo.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-emissions-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.emissions.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-icon-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.icon.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-int2lm-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.int2lm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-prepare-data-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.prepare_data.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-oae-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.oae.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-obs-nudging-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.obs_nudging.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-octe-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.octe.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-online-vprm-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.online_vprm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-photo-rate-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.photo_rate.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-post-int2lm-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.post_int2lm.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-reduce-output-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.reduce_output.main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config.html#variables-for-jobs-verify-chain-main">Variables for <code class="xref py py-func docutils literal notranslate"><span class="pre">jobs.verify_chain.main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../namelists.html">Namelist Templates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jobs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../jobs.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jobs.html#adding-new-jobs">Adding new jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jobs.html#list-of-available-jobs">List of available jobs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.biofluxes.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.check_output.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.cosmo.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.emissions.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.icon.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.int2lm.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.prepare_data.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.oem.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.obs_nudging.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.octe.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.online_vprm.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.photo_rate.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.post_cosmo.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.post_int2lm.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.reduce_output.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html#jobs.verify_chain.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools.html#conversion-functions">Conversion Functions</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #5d6d7e" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Processing Chain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jobs.check_output</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jobs.check_output</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">distutils.dir_util</span> <span class="kn">import</span> <span class="n">copy_tree</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tools</span>


<span class="k">def</span> <span class="nf">pkl_path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the path (and creates it, if necessary) to the stored</span>
<span class="sd">    pandas data file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    folder : str</span>
<span class="sd">        Path to the chain_root or the output_root</span>
<span class="sd">    pid : int</span>
<span class="sd">        Process ID in case of parallel exectution</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_path : str</span>
<span class="sd">        Full file path to pickle file</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Main file with complete content</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;data.pkl&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Split file per process</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>

    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>


<span class="k">def</span> <span class="nf">timeseries_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the path (and creates it, if necessary) to the timeseries</span>
<span class="sd">    plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_path : str</span>
<span class="sd">        Full file path to timeseries directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;timeseries&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>


<span class="k">def</span> <span class="nf">maps_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the path (and creates it, if necessary) to the map plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_folder : str</span>
<span class="sd">        Full file path to maps directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;check_output maps&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_folder</span>


<span class="k">def</span> <span class="nf">animations_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the path (and creates it, if necessary) to the animations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_folder : str</span>
<span class="sd">        Full file path to animations directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;animations&#39;</span><span class="p">)</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;animations&#39;</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;animations&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>


<span class="k">def</span> <span class="nf">tracername2gas</span><span class="p">(</span><span class="n">tracername</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the chemical symbol from the COSMO tracer name to be </span>
<span class="sd">    recognized by the helper convert_unit() function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    tracername : str</span>
<span class="sd">        Full name of the tracer in COSMO output file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gas : str</span>
<span class="sd">        Chemical symbol as used in helper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gas</span> <span class="o">=</span> <span class="n">tracername</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">gas</span> <span class="o">==</span> <span class="s1">&#39;NOX&#39;</span><span class="p">:</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="s1">&#39;NO2&#39;</span>
    <span class="k">elif</span> <span class="n">gas</span> <span class="o">==</span> <span class="s1">&#39;C14&#39;</span><span class="p">:</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="s1">&#39;14CO2&#39;</span>

    <span class="k">return</span> <span class="n">gas</span>


<span class="k">def</span> <span class="nf">get_variable_names</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get unique variable names from dataframe.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cols : list of str</span>
<span class="sd">        List of column names from dataframe </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    varnames : list of str</span>
<span class="sd">        List of unique variable names (e.g., CO2_A, NOX_BG, ...)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">todels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">split_col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">todel</span> <span class="ow">in</span> <span class="n">todels</span><span class="p">:</span>
            <span class="n">split_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">todel</span><span class="p">,</span> <span class="n">split_col</span><span class="p">))</span>
        <span class="n">varnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_col</span><span class="p">))</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">varnames</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">varnames</span>


<span class="k">def</span> <span class="nf">get_units</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="n">varnames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get units of variables from netCDF files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infiles : list of str</span>
<span class="sd">        List of netCDF files </span>
<span class="sd">    varnames : list of str</span>
<span class="sd">        List of unique variable names (e.g., CO2_A, NOX_BG, ...)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary containing units of variable names</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">infiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">:</span>
        <span class="n">DS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">starttime</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                    <span class="n">units</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">units</span>


<span class="k">def</span> <span class="nf">plot_timeseries</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plot of the min, max, mean and std values as time series. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary containing units os variables</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">ts_path</span> <span class="o">=</span> <span class="n">timeseries_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="n">varnames</span> <span class="o">=</span> <span class="n">get_variable_names</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># Tweak figure properties</span>
    <span class="n">style_label</span> <span class="o">=</span> <span class="s1">&#39;seaborn-whitegrid&#39;</span>
    <span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span>
    <span class="n">fig_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig_width</span> <span class="o">*</span> <span class="mf">2.2</span><span class="p">,</span> <span class="n">fig_height</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting </span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

        <span class="c1"># Get diagnostic values</span>
        <span class="n">vmean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span><span class="p">]</span>
        <span class="n">vstd</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span><span class="p">]</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span><span class="p">]</span>

        <span class="c1"># Unit conversion</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CO2_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CO_&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CH4_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C14_&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NOX_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NO2_&#39;</span><span class="p">)):</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="n">tracername2gas</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="n">in_unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
            <span class="n">out_unit</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">common_unit</span><span class="p">(</span><span class="n">gas</span><span class="p">)</span>
            <span class="n">vmean</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vmean</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
            <span class="n">vstd</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vstd</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_unit</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

        <span class="c1"># Figure options</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">num</span><span class="o">=</span><span class="n">style_label</span><span class="p">,</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">,</span>
                                 <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vmean</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ground-level mean values&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Global minimum values&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Global maximum values&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Datetime&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ts_path</span><span class="p">,</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_data_single_file</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">chain_src_dir</span><span class="p">,</span> <span class="n">casename</span><span class="p">,</span> <span class="n">chain_root</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetches the diagnostic data from COSMO output files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infile : str</span>
<span class="sd">        Full file name to be read</span>
<span class="sd">    chain_src_dir : str</span>
<span class="sd">        Path to the directory where the processing chain is ran</span>
<span class="sd">    casename : str</span>
<span class="sd">        Name of the current case</span>
<span class="sd">    chain_root : str</span>
<span class="sd">        Path to the processing chain directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="n">DS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="n">ground_level</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nctime</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Read values from variables.csv</span>
    <span class="n">alternate_csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_src_dir</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="n">casename</span><span class="p">,</span>
                                      <span class="s1">&#39;variables.csv&#39;</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">find_variables_file</span><span class="p">(</span><span class="n">alternate_csv_file</span><span class="p">)</span>

    <span class="c1"># Drop variables without min/max values</span>
    <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;min_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;max_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;min_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;max_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min_value&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;max_value&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get variable names</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

    <span class="n">data_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># Loop over variables</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">nctime</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1">#logging.warning(&#39;%s: Variable not in output file \n%s&#39; %(varname,infile))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">da_ground</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">ground_level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">nctime</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">da_ground</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">varname</span><span class="p">,</span> <span class="s1">&#39;min_value&#39;</span><span class="p">])</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">varname</span><span class="p">,</span> <span class="s1">&#39;max_value&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:10s}</span><span class="s2"> (min: </span><span class="si">{:11.4e}</span><span class="s2">, max: </span><span class="si">{:11.4e}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">varname</span><span class="p">,</span> <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">))</span>

        <span class="n">varmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
        <span class="n">varmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
        <span class="n">varmin_ground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">da_ground</span><span class="p">)</span>
        <span class="n">varmax_ground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">da_ground</span><span class="p">)</span>
        <span class="n">varmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">da_ground</span><span class="p">)</span>
        <span class="n">varstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">da_ground</span><span class="p">)</span>

        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varmin</span>
        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varmax</span>
        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_min_ground&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varmin_ground</span>
        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_max_ground&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varmax_ground</span>
        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varmean</span>
        <span class="n">data_values</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">varstd</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">da</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1"> has NaNs!&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">infile</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">varmin</span> <span class="o">&lt;</span> <span class="n">minval</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1"> falls below minimum value!</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Allowed min = </span><span class="si">%e</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Actual min = </span><span class="si">%e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">minval</span><span class="p">,</span> <span class="n">varmin</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">varmax</span> <span class="o">&gt;</span> <span class="n">maxval</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Variable </span><span class="si">%s</span><span class="s1"> in file </span><span class="si">%s</span><span class="s1"> exceeds maximum value!</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Allowed max = </span><span class="si">%e</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Actual max = </span><span class="si">%e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="n">varmax</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="c1"># Get the time from the name</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">infile</span><span class="p">)[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">ctime</span><span class="p">])</span>

    <span class="c1"># Store the time series of min and max in a pandas file format.</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Storing data to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">chain_root</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span>
    <span class="n">store_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">chain_root</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">merge_data</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Merges multiple pickle files into one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        Dataframe containing the whole diagnostic data </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">)</span>
    <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s2">&quot;data_*.pkl&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">history</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">history</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">store_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Stores the time series diagnostic data in a pandas dataframe.</span>
<span class="sd">    Appends it to the existing file, without overwriting the previous dates. </span>
<span class="sd">    This is useful if this is a continuous run with a spin-up period or </span>
<span class="sd">    when using binary restart files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe containing diagnostic values for each variable</span>
<span class="sd">    folder : str</span>
<span class="sd">        Path to the folder where the results are stored</span>
<span class="sd">    pid : int</span>
<span class="sd">        Process ID in case of parallel exectution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_footnotetext</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Formats the footnote text for map plots.</span>
<span class="sd">    </span>
<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    field : numpy.array</span>
<span class="sd">        Two-dimensional field of data to be shown in the plot</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    footnotetext : str</span>
<span class="sd">        Formatted footnote text with min/max/mean values of the field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="n">fmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="n">footnotetext</span> <span class="o">=</span> <span class="s1">&#39;min: &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmin</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="s1">&#39;  max: &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmax</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="s1">&#39;  mean: &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmean</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">footnotetext</span>


<span class="k">def</span> <span class="nf">get_infiles</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a sorted file list of COSMO output files without *c.nc file. </span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to the COSMO output folder</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    infiles : list of str</span>
<span class="sd">        Sorted List of filenames of COSMO ouputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;lffd*.nc&quot;</span><span class="p">)))</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">infile</span> <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">infile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;lffd&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;c&#39;</span>
    <span class="p">]</span>

    <span class="c1"># If this is a spin-up simulation, skip the first output files</span>
    <span class="n">timestr</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">))))</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">timestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">spinup_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spinup_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">infiles</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">ftime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">fname</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ftime</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">infiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">infiles</span>


<span class="k">def</span> <span class="nf">plot_single_map</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">varnames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Plots 2D maps of certain variables from a netCDF file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe containing diagnostic values for each variable</span>
<span class="sd">    infile : str</span>
<span class="sd">        Full file name to be read</span>
<span class="sd">    output_path: str</span>
<span class="sd">        Full path where output files should be generated</span>
<span class="sd">    varnames : list of str</span>
<span class="sd">        Names of variables to be processed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read in files</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="n">DS</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="n">ground_level</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nctime</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">nctime</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">ts</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
    <span class="n">timestr</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H&quot;</span><span class="p">)</span>

    <span class="n">rlon</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;rlon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">rlat</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;rlat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">pollon</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s2">&quot;rotated_pole&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;grid_north_pole_longitude&quot;</span><span class="p">]</span>
    <span class="n">pollat</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="s2">&quot;rotated_pole&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;grid_north_pole_latitude&quot;</span><span class="p">]</span>
    <span class="n">startlon</span> <span class="o">=</span> <span class="n">rlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">endlon</span> <span class="o">=</span> <span class="n">rlon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">startlat</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">endlat</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">Domain</span><span class="p">(</span><span class="s1">&#39;COSMO&#39;</span><span class="p">,</span>
                                 <span class="n">startlon</span><span class="p">,</span>
                                 <span class="n">startlat</span><span class="p">,</span>
                                 <span class="n">endlon</span><span class="p">,</span>
                                 <span class="n">endlat</span><span class="p">,</span>
                                 <span class="n">pollon</span><span class="o">=</span><span class="n">pollon</span><span class="p">,</span>
                                 <span class="n">pollat</span><span class="o">=</span><span class="n">pollat</span><span class="p">)</span>

    <span class="c1"># Check for rotated pole coordinates</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">RotatedPole</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;domain needs to use rotated pole coords&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">nctime</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Variable not in output file </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">infile</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">field</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">ground_level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">nctime</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="n">convert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Unit conversion</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CO2_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CO_&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CH4_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C14_&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NOX_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">varname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NO2_&#39;</span><span class="p">)):</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="n">tracername2gas</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="n">in_unit</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
            <span class="n">out_unit</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">common_unit</span><span class="p">(</span><span class="n">gas</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_unit</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>

        <span class="c1"># Set min/max for colorbar and convert if needed</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s2">&quot;_min_ground&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">varname</span> <span class="o">+</span> <span class="s2">&quot;_max_ground&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">convert_unit</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="n">in_unit</span><span class="p">,</span> <span class="n">out_unit</span><span class="p">,</span> <span class="n">gas</span><span class="p">)</span>

        <span class="c1"># Set manual min/max range in case they are equal</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="n">vmin</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">==</span> <span class="n">vmin</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Create figure and axes objects</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">domain</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Dimensions</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">rlon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">rlon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlon</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">rlon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlon</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlat</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">rlat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlat</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">startlon</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">stoplon</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">startlat</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">stoplat</span><span class="p">)</span>

        <span class="c1"># Annotations</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">timestr</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">footnotetext</span> <span class="o">=</span> <span class="n">write_footnotetext</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">footnotetext</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="c1"># Add coastlines</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;admin_0_boundary_lines_land&#39;</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span>
                       <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                       <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                       <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>

        <span class="c1"># Fill the plot</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">field</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                       <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                       <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                       <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">),</span>
                       <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">domain</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span>

        <span class="c1"># Colorbar</span>
        <span class="n">cax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">out_unit</span><span class="p">)</span>

        <span class="c1"># Save figure</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span>
                                 <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">timestr</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_map_directories</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create folders for the 2D maps of variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>
<span class="sd">    data: pandas.DataFrame</span>
<span class="sd">        Dataframe containing diagnostic values for each variable</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary of units per variable name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">maps_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># Get variable names</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">get_variable_names</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># Create directories per variable for map plots</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_animations</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates animated *.gif files from map plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">pkl_path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># Get variable names</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">get_variable_names</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">map_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">animations_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">infile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">map_path</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
        <span class="n">infiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infile_path</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">)))</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">:</span>
            <span class="n">new_frame</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_frame</span><span class="p">)</span>

        <span class="c1"># Save into a GIF file</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">varname</span> <span class="o">+</span> <span class="s1">&#39;.gif&#39;</span><span class="p">)</span>
        <span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span>
                       <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF&#39;</span><span class="p">,</span>
                       <span class="n">append_images</span><span class="o">=</span><span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                       <span class="n">save_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">duration</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../jobs.html#jobs.check_output.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">model_cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks output variables whether they are in a phyiscally reasonable</span>
<span class="sd">    range.</span>

<span class="sd">    Stores the time series of the minimum, the maximum, the mean, and</span>
<span class="sd">    the std of the variables as a pandas object into a pickle file.</span>

<span class="sd">    Creates per-variable plots from the stored time series data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------	</span>
<span class="sd">    cfg : config-object</span>
<span class="sd">        Object holding all user-configuration parameters as attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

    <span class="n">to_print</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;check_output</span>

<span class="s2">=====================================================</span>
<span class="s2">============== POST PROCESSING BEGINS ===============</span>
<span class="s2">============== StartTime: </span><span class="si">%s</span><span class="s2"> </span>
<span class="s2">=====================================================&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_working_dir</span><span class="p">,</span> <span class="s2">&quot;check_output&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">to_print</span><span class="p">)</span>

    <span class="c1"># if cfg.compute_host!=&quot;daint&quot;:</span>
    <span class="c1">#     logging.error(&quot;The check_output script is supposed to be run on daint only, &quot;</span>
    <span class="c1">#                   &quot;not on %s&quot; % cfg.compute_host)</span>
    <span class="c1">#     sys.exit(1)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for Cosmo to finish first&quot;&quot;&quot;</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">check_job_completion</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_finished_dir</span><span class="p">,</span> <span class="s2">&quot;cosmo&quot;</span><span class="p">,</span>
                               <span class="n">waittime</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># check every 30 seconds</span>

    <span class="c1"># Get list of files</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting list of input files&#39;</span><span class="p">)</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="n">get_infiles</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_output</span><span class="p">)</span>

    <span class="c1"># Get data from COSMO output files</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting data from COSMO output files&#39;</span><span class="p">)</span>
    <span class="n">to_write</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#!/usr/bin/env bash</span>
<span class="s2">#SBATCH --partition=debug</span>
<span class="s2">#SBATCH --account=em05</span>
<span class="s2">#SBATCH --job-name=&quot;check_output_</span><span class="si">{cfg.startdate_sim_yyyymmddhh}</span><span class="s2">_</span><span class="si">{cfg.forecasttime}</span><span class="s2">&quot;</span>
<span class="s2">#SBATCH --open-mode=append</span>
<span class="s2">#SBATCH --time=00:30:00</span>
<span class="s2">#SBATCH --constraint=mc</span>
<span class="s2">#SBATCH --ntasks=1</span>
<span class="s2">#SBATCH --output=</span><span class="si">{logfile}</span>


<span class="s2">export EASYBUILD_PREFIX=/store/empa/em05/easybuild</span>
<span class="s2">export ECCODES_DEFINITION_PATH=/store/empa/em05/easybuild/software/ecCodes/2.12.5-CrayGNU-19.10/share/eccodes/definitions/</span>

<span class="s2">module load daint-mc</span>
<span class="s2">module load EasyBuild-custom</span>

<span class="s2">module load daint-mc</span>
<span class="s2">module load EasyBuild-custom</span>

<span class="s2">module load cray-python/3.8.5.0</span>
<span class="s2">module load PyExtensions/python3-CrayGNU-20.11</span>

<span class="s2">module load GEOS</span>
<span class="s2">module load PROJ/4.9.3-CrayGNU-20.11</span>
<span class="s2">module load ecCodes</span>
<span class="s2">#module load GDAL                         # FIXME: currently easybuild install is not working</span>

<span class="s2"># source /store/empa/em05/pyvenv-3.8/bin/activate</span>
<span class="s2">source ~/python/stem2/bin/activate</span>

<span class="s2">srun python jobs/check_output.py </span><span class="si">{casename}</span><span class="s2"> </span><span class="si">{cosmo_output}</span><span class="s2"> </span><span class="si">{output_root}</span><span class="s2"> </span><span class="si">{chain}</span><span class="s2"> </span><span class="si">{chain_root}</span><span class="s2"> </span><span class="si">{action}</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">to_write_fmt</span> <span class="o">=</span> <span class="n">to_write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                   <span class="n">casename</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">,</span>
                                   <span class="n">cosmo_output</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_output</span><span class="p">,</span>
                                   <span class="n">output_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span>
                                   <span class="n">work_log</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">log_working_dir</span><span class="p">,</span>
                                   <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span>
                                   <span class="n">chain</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_src_dir</span><span class="p">,</span>
                                   <span class="n">chain_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span>
                                   <span class="n">action</span><span class="o">=</span><span class="s1">&#39;get_data&#39;</span><span class="p">)</span>

    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_work</span><span class="p">,</span> <span class="s2">&quot;get_data.job&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_write_fmt</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;sbatch&quot;</span><span class="p">,</span> <span class="s2">&quot;--wait&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">])</span>
    <span class="n">exitcode</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

    <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;sbatch returned exitcode </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exitcode</span><span class="p">))</span>

    <span class="c1"># Merge data to single pickle file</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Merging data to single pickle file&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">merge_data</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="c1"># Get variable names</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting variable names&#39;</span><span class="p">)</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">get_variable_names</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>

    <span class="c1"># Get units</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading units&#39;</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">get_units</span><span class="p">(</span><span class="n">infiles</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># Plots</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating timeseries plots in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">timeseries_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
    <span class="n">plot_timeseries</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating map plots in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">maps_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
    <span class="n">create_map_directories</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="n">to_write_fmt</span> <span class="o">=</span> <span class="n">to_write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span>
                                   <span class="n">casename</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">casename</span><span class="p">,</span>
                                   <span class="n">cosmo_output</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_output</span><span class="p">,</span>
                                   <span class="n">output_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span>
                                   <span class="n">logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">,</span>
                                   <span class="n">chain</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_src_dir</span><span class="p">,</span>
                                   <span class="n">chain_root</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span>
                                   <span class="n">action</span><span class="o">=</span><span class="s1">&#39;plot_maps&#39;</span><span class="p">)</span>

    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">cosmo_work</span><span class="p">,</span> <span class="s2">&quot;plot_maps.job&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
        <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_write_fmt</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;sbatch&quot;</span><span class="p">,</span> <span class="s2">&quot;--wait&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">])</span>
    <span class="n">exitcode</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

    <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;sbatch returned exitcode </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exitcode</span><span class="p">))</span>

    <span class="c1"># Move map plots to output directory</span>
    <span class="n">src_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">)</span>
    <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Move map plots to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dest_folder</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src_folder</span><span class="p">,</span> <span class="n">dest_folder</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
            <span class="n">fromDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_folder</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="n">toDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
            <span class="n">copy_tree</span><span class="p">(</span><span class="n">fromDirectory</span><span class="p">,</span> <span class="n">toDirectory</span><span class="p">)</span>

    <span class="c1"># Animations</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating animations in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">animations_path</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
    <span class="n">create_animations</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">to_print</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;=====================================================</span>
<span class="s2">============== POST PROCESSING ENDS ==================</span>
<span class="s2">============== EndTime: </span><span class="si">%s</span>
<span class="s2">=====================================================&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">to_print</span><span class="p">)</span>

    <span class="c1"># Check for errors</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ERROR&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Logfile containing errors! See </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">logfile</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

    <span class="n">casename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cosmo_output</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">output_root</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">chain_src_dir</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">chain_root</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="s1">&#39;check_output&#39;</span><span class="p">,</span> <span class="s1">&#39;data.pkl&#39;</span><span class="p">)</span>
    <span class="n">infiles</span> <span class="o">=</span> <span class="n">get_infiles</span><span class="p">(</span><span class="n">cosmo_output</span><span class="p">)</span>

    <span class="n">nthread</span> <span class="o">=</span> <span class="mi">36</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;plot_maps&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">nthread</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
            <span class="c1"># Get variable names</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">)</span>
            <span class="n">varnames</span> <span class="o">=</span> <span class="n">get_variable_names</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">plot_single_map</span><span class="p">,</span>
                         <span class="p">[(</span><span class="n">data</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">varnames</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;get_data&#39;</span><span class="p">:</span>
        <span class="c1"># Loop over all files and check values</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">nthread</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">get_data_single_file</span><span class="p">,</span>
                         <span class="p">[(</span><span class="n">infile</span><span class="p">,</span> <span class="n">chain_src_dir</span><span class="p">,</span> <span class="n">casename</span><span class="p">,</span> <span class="n">chain_root</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">infile</span> <span class="ow">in</span> <span class="n">infiles</span><span class="p">])</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, C2SM.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>