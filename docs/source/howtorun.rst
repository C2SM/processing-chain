.. _script-section:

How to Run
==========

The Python file ``run_chain.py`` in the root directory is the main script of the
Processing Chain.
It reads the user's input from the command line and from the ``config.py`` file of the
respective case.
Then it will start the Processing Chain.

Starting the Chain
------------------

The chain has to be run with the following command: ::

    $ python run_chain.py <casename> <startdate> <hstart> <hstop> -j [jobs]

``<casename>`` is the name of a directory in the ``cases/``-directory where
there is a ``config.py``-file specifying the configurations, as well as templates
for the necessary namelist files for **int2lm**, **COSMO** or **ICON**.

If you don't supply a joblist, the default joblist will be executed.

For **COSMO**, that is ``meteo`` ``icbc`` ``emissions`` ``biofluxes`` ``int2lm``
``post_int2lm`` ``cosmo`` ``post_cosmo``,

For **COSMOART** it is ``meteo`` ``icbc`` ``emissions`` ``obs_nudging``
``photo_rate`` ``int2lm`` ``cosmo`` ``post_cosmo``.

For **ICON** it is ``meteo`` ``icon``.

For **ICONART** it is ``meteo`` ``icbc`` ``icon``.

For **ICONOEM** it is ``meteo`` ``icbc`` ``oae`` ``icon``.

The model type can be chosen by setting the variable ``target`` in the ``config.py``-file.

To run the **COSMO-GHG** example test case, run::

    $ python run_chain.py cosmo-ghg-11km-test 2015-01-01 0 24 -j meteo icbc emissions biofluxes int2lm post_int2lm cosmo post_cosmo

To run the **COSMO-ART** example case, run::

    $ python run_chain.py cosmo-art-mother-test cosmo-art-nested-test 2015-02-04 0 12 -j meteo icbc emissions obs_nudging photo_rate int2lm cosmo post_cosmo

To run the **ICON** example case, run::

    $ python run_chain.py icon-test 2018-01-01 0 24 -j meteo icon

To run the **ICON-OEM** example case, run::

    $ python run_chain.py icon-oem-test 2018-01-01 0 24 -j meteo icbc oae icon

        
What it Does
------------

The script ``run_chain.py`` reads the command-line arguments and the config-file.
It then calls the function :func:`run_chain.restart_runs` which divides the
simuation time according to the specified restart steps. Then it calls
:func:`run_chain.run_chain` for each sub-run. This function sets up the directory
structure of the chain and then starts the specified :ref:`jobs<jobs-section>`
sequentially.

The directory structure generated by the Processing Chain for a **COSMO** run
looks like this:::

  cfg.work_root/
    + output/cfg.output_root/
    \ <casename>/cfg.chain_root/
                   + cfg.int2lm_base/
		   |   + cfg.int2lm_input/
		   |   + cfg.int2lm_work/
		   |   \ cfg.int2lm_output/
		   + cfg.cosmo_base/
		   |   + cfg.cosmo_work/
		   |   + cfg.cosmo_output/
		   |   \ cfg.cosmo_restart_out/
		   \ checkpoints/
		       + cfg.log_working_dir/
		       \ cfg.log_finished_dir/
                   
Running the ``cosmo-ghg-11km-test``-case therefore produces the following directories:::

  $SCRATCH/processing_chain/
             + output/cosmo-ghg-11km-test
	     \ cosmo-ghg-11km-test/2015010100_0_24/
	                 + int2lm/
			 |   + input/
			 |   |  + emissions/
			 |   |  + extpart/
			 |   |  + icbc/
			 |   |  + meteo/
			 |   |  \ vprm/
			 |   + run/
			 |   |  + int2lm   # executable
			 |   |  + INPUT
			 |   |  \ run.job
			 |   \ output/
			 + cosmo/
			 |   + run/
			 |   |  + cosmo    # executable
			 |   |  + INPUT_*
			 |   |  \ run.job
			 |   + output/
			 |   \ restart/
			 \ checkpoints
			     + working/    # 1 logfile per started job
			     \ finished    # 1 logfile per finished job


Functions in ``run_chain.py``
-----------------------------

.. autofunction:: run_chain.restart_runs

.. autofunction:: run_chain.restart_runs_spinup

.. autofunction:: run_chain.run_chain

.. autofunction:: run_chain.load_config_file

.. autofunction:: run_chain.set_simulation_type

.. autofunction:: run_chain.parse_arguments

